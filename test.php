<?php
// Assuming the order JSON is stored in $orderJson (as a string)
$orderJson = '{"id":11702334685566,"admin_graphql_api_id":"gid:\/\/shopify\/Order\/11702334685566","app_id":580111,"browser_ip":"2a00:23c7:89a1:1d01:b0fc:1cfa:c473:84de","buyer_accepts_marketing":false,"cancel_reason":null,"cancelled_at":null,"cart_token":"Z2NwLWV1cm9wZS13ZXN0NDowMUpRTTVBMTM2WTYyRTg0SzNBVFRYSE5HUg","checkout_id":64265378824574,"checkout_token":"1231846fb8b764456b723cff4c60d524","client_details":{"accept_language":"en-GB","browser_height":null,"browser_ip":"2a00:23c7:89a1:1d01:b0fc:1cfa:c473:84de","browser_width":null,"session_hash":null,"user_agent":"Mozilla\/5.0 (Linux; Android 10; K) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/134.0.0.0 Mobile Safari\/537.36"},"closed_at":"2025-03-31T11:20:55+01:00","confirmation_number":"NIEGFW5NM","confirmed":true,"contact_email":"kayleighbusinessmail@gmail.com","created_at":"2025-03-30T19:34:30+01:00","currency":"GBP","current_shipping_price_set":{"shop_money":{"amount":"2.85","currency_code":"GBP"},"presentment_money":{"amount":"2.85","currency_code":"GBP"}},"current_subtotal_price":"12.99","current_subtotal_price_set":{"shop_money":{"amount":"12.99","currency_code":"GBP"},"presentment_money":{"amount":"12.99","currency_code":"GBP"}},"current_total_additional_fees_set":null,"current_total_discounts":"0.00","current_total_discounts_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"current_total_duties_set":null,"current_total_price":"15.84","current_total_price_set":{"shop_money":{"amount":"15.84","currency_code":"GBP"},"presentment_money":{"amount":"15.84","currency_code":"GBP"}},"current_total_tax":"2.64","current_total_tax_set":{"shop_money":{"amount":"2.64","currency_code":"GBP"},"presentment_money":{"amount":"2.64","currency_code":"GBP"}},"customer_locale":"en-GB","device_id":null,"discount_codes":[],"duties_included":false,"email":"kayleighbusinessmail@gmail.com","estimated_taxes":false,"financial_status":"partially_refunded","fulfillment_status":"fulfilled","landing_site":"\/collections\/toothbrushes?tw_source=ig\u0026tw_adid=120217726490520511\u0026fbclid=PAZXh0bgNhZW0BMABhZGlkAasaIPfPQD8BpnYZCLTaxpAQOQYC5ojx6hdsnq8DQp395abXT_51HgWIG4n2PJUAZswd5A_aem_pgAsbbWV2qK39CuGqoQfpQ\u0026utm_source=facebook\u0026utm_medium=paid\u0026campaign_id=120204298863320511\u0026ad_id=120217726490520511","landing_site_ref":null,"location_id":null,"merchant_business_entity_id":"MTI0ODI0OTcxMzQ0","merchant_of_record_app_id":null,"name":"#39878","note":null,"note_attributes":[{"name":"RecartSessionId","value":"67e98e22f605800d849b3005"},{"name":"RecartShopperId","value":"67e98e220d262c4cb93d2fff"}],"number":38878,"order_number":39878,"order_status_url":"https:\/\/matchstickmonkey.co.uk\/24824971344\/orders\/b27fa50015b030e93b3fa62d07749f7b\/authenticate?key=2edb8f7c8c993a7ef3c26f5e89aa332a","original_total_additional_fees_set":null,"original_total_duties_set":null,"payment_gateway_names":["shopify_payments"],"phone":null,"po_number":null,"presentment_currency":"GBP","processed_at":"2025-03-30T19:34:24+01:00","reference":null,"referring_site":"https:\/\/mybandou.com\/","source_identifier":null,"source_name":"web","source_url":null,"subtotal_price":"25.74","subtotal_price_set":{"shop_money":{"amount":"25.74","currency_code":"GBP"},"presentment_money":{"amount":"25.74","currency_code":"GBP"}},"tags":"OCU Zipify Post-Purchase Upsell Bought","tax_exempt":false,"tax_lines":[{"price":"4.77","rate":0.2,"title":"GB VAT","price_set":{"shop_money":{"amount":"4.77","currency_code":"GBP"},"presentment_money":{"amount":"4.77","currency_code":"GBP"}},"channel_liable":false}],"taxes_included":true,"test":false,"token":"b27fa50015b030e93b3fa62d07749f7b","total_cash_rounding_payment_adjustment_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"total_cash_rounding_refund_adjustment_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"total_discounts":"2.24","total_discounts_set":{"shop_money":{"amount":"2.24","currency_code":"GBP"},"presentment_money":{"amount":"2.24","currency_code":"GBP"}},"total_line_items_price":"27.98","total_line_items_price_set":{"shop_money":{"amount":"27.98","currency_code":"GBP"},"presentment_money":{"amount":"27.98","currency_code":"GBP"}},"total_outstanding":"0.00","total_price":"28.59","total_price_set":{"shop_money":{"amount":"28.59","currency_code":"GBP"},"presentment_money":{"amount":"28.59","currency_code":"GBP"}},"total_shipping_price_set":{"shop_money":{"amount":"2.85","currency_code":"GBP"},"presentment_money":{"amount":"2.85","currency_code":"GBP"}},"total_tax":"4.77","total_tax_set":{"shop_money":{"amount":"4.77","currency_code":"GBP"},"presentment_money":{"amount":"4.77","currency_code":"GBP"}},"total_tip_received":"0.00","total_weight":0,"updated_at":"2025-04-01T09:30:42+01:00","user_id":null,"billing_address":{"first_name":"Kayleigh","address1":"Woodlin House, Woodchurch Road","phone":"+447931492217","city":"Ashford","zip":"TN26 1LQ","province":"England","country":"United Kingdom","last_name":"Doyle","address2":null,"company":null,"latitude":51.1077461,"longitude":0.8166973,"name":"Kayleigh Doyle","country_code":"GB","province_code":"ENG"},"customer":{"id":23298795110782,"email":"kayleighbusinessmail@gmail.com","created_at":"2025-03-30T19:33:12+01:00","updated_at":"2025-04-01T09:30:46+01:00","first_name":"Kayleigh","last_name":"Doyle","state":"disabled","note":null,"verified_email":true,"multipass_identifier":null,"tax_exempt":false,"phone":"+447931492217","currency":"GBP","tax_exemptions":[],"admin_graphql_api_id":"gid:\/\/shopify\/Customer\/23298795110782","default_address":{"id":34744681496958,"customer_id":23298795110782,"first_name":"Kayleigh","last_name":"Doyle","company":null,"address1":"Woodlin House, Woodchurch Road","address2":null,"city":"Ashford","province":"England","country":"United Kingdom","zip":"TN26 1LQ","phone":"07931492217","name":"Kayleigh Doyle","province_code":"ENG","country_code":"GB","country_name":"United Kingdom","default":true}},"discount_applications":[{"target_type":"line_item","type":"manual","value":"15.0","value_type":"percentage","allocation_method":"across","target_selection":"explicit","title":null,"description":null}],"fulfillments":[{"id":6852891246974,"admin_graphql_api_id":"gid:\/\/shopify\/Fulfillment\/6852891246974","created_at":"2025-03-31T11:20:55+01:00","location_id":33953251408,"name":"#39878.1","order_id":11702334685566,"origin_address":{},"receipt":{},"service":"manual","shipment_status":null,"status":"success","tracking_company":"Royal Mail","tracking_number":"2D0464431000000081A99","tracking_numbers":["2D0464431000000081A99"],"tracking_url":"https:\/\/www.royalmail.com\/track-your-item#\/tracking-results\/2D0464431000000081A99","tracking_urls":["https:\/\/www.royalmail.com\/track-your-item#\/tracking-results\/2D0464431000000081A99"],"updated_at":"2025-03-31T11:20:55+01:00","line_items":[{"id":34823638516094,"admin_graphql_api_id":"gid:\/\/shopify\/LineItem\/34823638516094","current_quantity":1,"fulfillable_quantity":0,"fulfillment_service":"manual","fulfillment_status":"fulfilled","gift_card":false,"grams":0,"name":"Baby Electric Sonic Toothbrush Gigi Giraffe","price":"12.99","price_set":{"shop_money":{"amount":"12.99","currency_code":"GBP"},"presentment_money":{"amount":"12.99","currency_code":"GBP"}},"product_exists":true,"product_id":6950622396496,"properties":[],"quantity":1,"requires_shipping":true,"sku":"MM-TB-BST-G-001","taxable":true,"title":"Baby Electric Sonic Toothbrush Gigi Giraffe","total_discount":"0.00","total_discount_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"variant_id":40551283064912,"variant_inventory_management":"shopify","variant_title":null,"vendor":"Matchstick Monkey UK","tax_lines":[{"channel_liable":false,"price":"2.17","price_set":{"shop_money":{"amount":"2.17","currency_code":"GBP"},"presentment_money":{"amount":"2.17","currency_code":"GBP"}},"rate":0.2,"title":"GB VAT"}],"duties":[],"discount_allocations":[]}]}],"line_items":[{"id":34823638516094,"admin_graphql_api_id":"gid:\/\/shopify\/LineItem\/34823638516094","current_quantity":1,"fulfillable_quantity":0,"fulfillment_service":"manual","fulfillment_status":"fulfilled","gift_card":false,"grams":0,"name":"Baby Electric Sonic Toothbrush Gigi Giraffe","price":"12.99","price_set":{"shop_money":{"amount":"12.99","currency_code":"GBP"},"presentment_money":{"amount":"12.99","currency_code":"GBP"}},"product_exists":true,"product_id":6950622396496,"properties":[],"quantity":1,"requires_shipping":true,"sales_line_item_group_id":null,"sku":"MM-TB-BST-G-001","taxable":true,"title":"Baby Electric Sonic Toothbrush Gigi Giraffe","total_discount":"0.00","total_discount_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"variant_id":40551283064912,"variant_inventory_management":"shopify","variant_title":null,"vendor":"Matchstick Monkey UK","tax_lines":[{"channel_liable":false,"price":"2.17","price_set":{"shop_money":{"amount":"2.17","currency_code":"GBP"},"presentment_money":{"amount":"2.17","currency_code":"GBP"}},"rate":0.2,"title":"GB VAT"}],"duties":[],"discount_allocations":[]},{"id":34823640023422,"admin_graphql_api_id":"gid:\/\/shopify\/LineItem\/34823640023422","current_quantity":0,"fulfillable_quantity":0,"fulfillment_service":"manual","fulfillment_status":null,"gift_card":false,"grams":0,"name":"Bathtime Slide Set Pink","price":"14.99","price_set":{"shop_money":{"amount":"14.99","currency_code":"GBP"},"presentment_money":{"amount":"14.99","currency_code":"GBP"}},"product_exists":true,"product_id":6867091652688,"properties":[],"quantity":1,"requires_shipping":true,"sales_line_item_group_id":null,"sku":"MM-B-SSG-003","taxable":true,"title":"Bathtime Slide Set Pink","total_discount":"2.24","total_discount_set":{"shop_money":{"amount":"2.24","currency_code":"GBP"},"presentment_money":{"amount":"2.24","currency_code":"GBP"}},"variant_id":40272003072080,"variant_inventory_management":"shopify","variant_title":null,"vendor":"Matchstick monkey belle","tax_lines":[{"channel_liable":false,"price":"2.13","price_set":{"shop_money":{"amount":"2.13","currency_code":"GBP"},"presentment_money":{"amount":"2.13","currency_code":"GBP"}},"rate":0.2,"title":"GB VAT"}],"duties":[],"discount_allocations":[{"amount":"2.24","amount_set":{"shop_money":{"amount":"2.24","currency_code":"GBP"},"presentment_money":{"amount":"2.24","currency_code":"GBP"}},"discount_application_index":0}]}],"payment_terms":null,"refunds":[{"id":1096713306494,"admin_graphql_api_id":"gid:\/\/shopify\/Refund\/1096713306494","created_at":"2025-03-31T09:27:26+01:00","note":null,"order_id":11702334685566,"processed_at":"2025-03-31T09:27:26+01:00","restock":true,"total_additional_fees_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"total_duties_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"user_id":40610005072,"order_adjustments":[],"transactions":[],"refund_line_items":[{"id":1017150210430,"line_item_id":34823640023422,"location_id":33953251408,"quantity":1,"restock_type":"cancel","subtotal":12.75,"subtotal_set":{"shop_money":{"amount":"12.75","currency_code":"GBP"},"presentment_money":{"amount":"12.75","currency_code":"GBP"}},"total_tax":2.13,"total_tax_set":{"shop_money":{"amount":"2.13","currency_code":"GBP"},"presentment_money":{"amount":"2.13","currency_code":"GBP"}},"line_item":{"id":34823640023422,"admin_graphql_api_id":"gid:\/\/shopify\/LineItem\/34823640023422","current_quantity":0,"fulfillable_quantity":0,"fulfillment_service":"manual","fulfillment_status":null,"gift_card":false,"grams":0,"name":"Bathtime Slide Set Pink","price":"14.99","price_set":{"shop_money":{"amount":"14.99","currency_code":"GBP"},"presentment_money":{"amount":"14.99","currency_code":"GBP"}},"product_exists":true,"product_id":6867091652688,"properties":[],"quantity":1,"requires_shipping":true,"sku":"MM-B-SSG-003","taxable":true,"title":"Bathtime Slide Set Pink","total_discount":"2.24","total_discount_set":{"shop_money":{"amount":"2.24","currency_code":"GBP"},"presentment_money":{"amount":"2.24","currency_code":"GBP"}},"variant_id":40272003072080,"variant_inventory_management":"shopify","variant_title":null,"vendor":"Matchstick monkey belle","tax_lines":[{"channel_liable":false,"price":"2.13","price_set":{"shop_money":{"amount":"2.13","currency_code":"GBP"},"presentment_money":{"amount":"2.13","currency_code":"GBP"}},"rate":0.2,"title":"GB VAT"}],"duties":[],"discount_allocations":[{"amount":"2.24","amount_set":{"shop_money":{"amount":"2.24","currency_code":"GBP"},"presentment_money":{"amount":"2.24","currency_code":"GBP"}},"discount_application_index":0}]}}],"duties":[],"additional_fees":[]},{"id":1096713503102,"admin_graphql_api_id":"gid:\/\/shopify\/Refund\/1096713503102","created_at":"2025-03-31T09:28:02+01:00","note":"","order_id":11702334685566,"processed_at":"2025-03-31T09:28:02+01:00","restock":false,"total_additional_fees_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"total_duties_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}},"user_id":40610005072,"order_adjustments":[{"id":482963784062,"amount":"12.75","amount_set":{"shop_money":{"amount":"12.75","currency_code":"GBP"},"presentment_money":{"amount":"12.75","currency_code":"GBP"}},"kind":"refund_discrepancy","order_id":11702334685566,"reason":"Refund discrepancy","refund_id":1096713503102,"tax_amount":"0.00","tax_amount_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}}},{"id":483174711678,"amount":"-12.75","amount_set":{"shop_money":{"amount":"-12.75","currency_code":"GBP"},"presentment_money":{"amount":"-12.75","currency_code":"GBP"}},"kind":"refund_discrepancy","order_id":11702334685566,"reason":"Pending refund discrepancy","refund_id":1096713503102,"tax_amount":"0.00","tax_amount_set":{"shop_money":{"amount":"0.00","currency_code":"GBP"},"presentment_money":{"amount":"0.00","currency_code":"GBP"}}}],"transactions":[{"id":12914607489406,"admin_graphql_api_id":"gid:\/\/shopify\/OrderTransaction\/12914607489406","amount":"12.75","authorization":"re_3R8Qh6IAEl5sO2Le17dAFLBO","created_at":"2025-03-31T09:28:02+01:00","currency":"GBP","device_id":null,"error_code":null,"gateway":"shopify_payments","kind":"refund","location_id":null,"message":"Transaction approved","order_id":11702334685566,"parent_id":12912018882942,"payment_id":"#39878.2","payments_refund_attributes":{"status":"success","acquirer_reference_number":null},"processed_at":"2025-04-01T09:30:42+01:00","receipt":{"id":"re_3R8Qh6IAEl5sO2Le17dAFLBO","amount":1275,"balance_transaction":{"id":"txn_3R8Qh6IAEl5sO2Le1iIf81nU","object":"balance_transaction","exchange_rate":null},"charge":{"id":"ch_3R8Qh6IAEl5sO2Le1n1JqdDO","object":"charge","amount":1275,"application_fee":"fee_1R8Qh9IAEl5sO2LeUNDTrqgZ","balance_transaction":"txn_3R8Qh6IAEl5sO2Le1grOgRSx","captured":true,"created":1743359693,"currency":"gbp","failure_code":null,"failure_message":null,"fraud_details":{},"livemode":true,"metadata":{"email":"kayleighbusinessmail@gmail.com","manual_entry":"false","order_id":"ra2xFm4GW5KI2EyoL2D4l7ZJn","order_transaction_id":"12912018882942","payments_charge_id":"4229415862654","shop_id":"24824971344","shop_name":"Matchstick Monkey UK","shopify_payments_next":"true","transaction_fee_tax_amount":"0","transaction_fee_total_amount":"47"},"outcome":{"advice_code":null,"network_advice_code":null,"network_decline_code":null,"network_status":"approved_by_network","reason":null,"risk_level":"normal","seller_message":"Payment complete.","type":"authorized"},"paid":true,"payment_intent":"pi_3R8Qh6IAEl5sO2Le10grI28o","payment_method":"pm_1R8Qh6IAEl5sO2Les6B2C3fW","payment_method_details":{"card":{"amount_authorized":1275,"authorization_code":"AVEXIB","brand":"mastercard","checks":{"address_line1_check":"pass","address_postal_code_check":"pass","cvc_check":null},"country":"GB","description":"World Debit Embossed MasterCard Card","ds_transaction_id":null,"exp_month":2,"exp_year":2029,"extended_authorization":{"status":"disabled"},"fingerprint":"1npmP34udEVJy1cV","funding":"debit","iin":"535522","incremental_authorization":{"status":"unavailable"},"installments":null,"issuer":"MONZO BANK LIMITED","last4":"7173","mandate":null,"moto":null,"multicapture":{"status":"unavailable"},"network":"mastercard","network_token":{"used":true},"network_transaction_id":"MDHAS388W0330","overcapture":{"maximum_amount_capturable":1275,"status":"unavailable"},"payment_account_reference":"500140HWOESJPEASKPL9F7ZS963EU","regulated_status":"unregulated","three_d_secure":null,"wallet":null},"type":"card"},"refunded":true,"source":null,"status":"succeeded","mit_params":{"network_transaction_id":"MDHAS388W0330"}},"object":"refund","reason":null,"status":"succeeded","created":1743496241,"currency":"gbp","metadata":{"order_transaction_id":"12914607489406","payments_refund_id":"216200577406","shopify_payments_next":"true"},"payment_method_details":{"card":{"acquirer_reference_number":null,"acquirer_reference_number_status":"pending"},"type":"card"},"mit_params":{}},"source_name":"1830279","status":"success","test":false,"user_id":40610005072,"payment_details":{"credit_card_bin":"535522","avs_result_code":"Y","cvv_result_code":null,"credit_card_number":"•••• •••• •••• 7173","credit_card_company":"Mastercard","buyer_action_info":null,"credit_card_name":"Kayleigh Doyle","credit_card_wallet":null,"credit_card_expiration_month":2,"credit_card_expiration_year":2029,"payment_method_name":"master"}}],"refund_line_items":[],"duties":[],"additional_fees":[]}],"shipping_address":{"first_name":"Kayleigh","address1":"Woodlin House, Woodchurch Road","phone":"07931492217","city":"Ashford","zip":"TN26 1LQ","province":"England","country":"United Kingdom","last_name":"Doyle","address2":null,"company":null,"latitude":51.1077461,"longitude":0.8166973,"name":"Kayleigh Doyle","country_code":"GB","province_code":"ENG"},"shipping_lines":[{"id":10885478482302,"carrier_identifier":null,"code":"Standard (3-5 working days)","current_discounted_price_set":{"shop_money":{"amount":"2.85","currency_code":"GBP"},"presentment_money":{"amount":"2.85","currency_code":"GBP"}},"discounted_price":"2.85","discounted_price_set":{"shop_money":{"amount":"2.85","currency_code":"GBP"},"presentment_money":{"amount":"2.85","currency_code":"GBP"}},"is_removed":false,"phone":null,"price":"2.85","price_set":{"shop_money":{"amount":"2.85","currency_code":"GBP"},"presentment_money":{"amount":"2.85","currency_code":"GBP"}},"requested_fulfillment_service_id":null,"source":"shopify","title":"Standard (3-5 working days)","tax_lines":[{"channel_liable":false,"price":"0.47","price_set":{"shop_money":{"amount":"0.47","currency_code":"GBP"},"presentment_money":{"amount":"0.47","currency_code":"GBP"}},"rate":0.2,"title":"GB VAT"}],"discount_allocations":[]}],"returns":[]};' ;
$order = json_decode($orderJson, true);

// Check if refunds exist
if (isset($order['refunds']) && !empty($order['refunds'])) {
    echo "Refunded Items:\n\n";
    
    foreach ($order['refunds'] as $refund) {
        if (isset($refund['refund_line_items'])) {
            foreach ($refund['refund_line_items'] as $item) {
                $lineItem = $item['line_item'];
                
                $title = $lineItem['title'];
                $quantity = $item['quantity'];
                $subtotal = $item['subtotal'];
                $tax = $item['total_tax'];
                $totalRefunded = $subtotal + $tax;

                echo "Item: $title\n";
                echo "Quantity Refunded: $quantity\n";
                echo "Refunded Amount (excl. tax): £" . number_format($subtotal, 2) . "\n";
                echo "Refunded Tax: £" . number_format($tax, 2) . "\n";
                echo "Total Refunded: £" . number_format($totalRefunded, 2) . "\n";
                echo "-------------------------\n";
            }
        }
    }
} else {
    echo "No refunded items found.\n";
}
?>
